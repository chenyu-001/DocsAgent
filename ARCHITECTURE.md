# ğŸ—ï¸ DocsAgent æŠ€æœ¯æ¶æ„è¯¦è§£

> ä¸€ä¸ªä¼ä¸šçº§çš„æ™ºèƒ½æ–‡æ¡£ç†è§£ç³»ç»Ÿï¼ŒåŸºäº RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰æŠ€æœ¯æ ˆ

---

## ğŸ“‹ ç›®å½•

- [ç³»ç»Ÿæ¦‚è§ˆ](#ç³»ç»Ÿæ¦‚è§ˆ)
- [æ ¸å¿ƒæŠ€æœ¯æ ˆ](#æ ¸å¿ƒæŠ€æœ¯æ ˆ)
- [æ•´ä½“æ¶æ„](#æ•´ä½“æ¶æ„)
- [æ–‡æ¡£å¤„ç†æµç¨‹](#æ–‡æ¡£å¤„ç†æµç¨‹)
- [RAG æ£€ç´¢å¢å¼ºç”Ÿæˆ](#rag-æ£€ç´¢å¢å¼ºç”Ÿæˆ)
- [å¤šç§Ÿæˆ·æ¶æ„](#å¤šç§Ÿæˆ·æ¶æ„)
- [æƒé™ç³»ç»Ÿ](#æƒé™ç³»ç»Ÿ)
- [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)

---

## ç³»ç»Ÿæ¦‚è§ˆ

### è®¾è®¡ç›®æ ‡

DocsAgent æ˜¯ä¸€ä¸ªé¢å‘ä¼ä¸šçš„æ–‡æ¡£ç†è§£ç³»ç»Ÿï¼Œæ ¸å¿ƒç›®æ ‡æ˜¯ï¼š

- âœ… **æ™ºèƒ½é—®ç­”**ï¼šåŸºäºä¸Šä¼ çš„æ–‡æ¡£ï¼Œä½¿ç”¨ AI å›ç­”ç”¨æˆ·é—®é¢˜
- âœ… **è¯­ä¹‰æ£€ç´¢**ï¼šä¸ä¾èµ–å…³é”®è¯åŒ¹é…ï¼Œç†è§£é—®é¢˜çš„è¯­ä¹‰å«ä¹‰
- âœ… **å¤šç§Ÿæˆ·éš”ç¦»**ï¼šæ”¯æŒå¤šä¸ªä¼ä¸š/éƒ¨é—¨ç‹¬ç«‹ä½¿ç”¨
- âœ… **ç»†ç²’åº¦æƒé™**ï¼šæ–‡æ¡£çº§ã€æ–‡ä»¶å¤¹çº§æƒé™æ§åˆ¶
- âœ… **ä¼ä¸šçº§å¯é æ€§**ï¼šå®Œæ•´çš„å®¡è®¡æ—¥å¿—ã€æ•°æ®éš”ç¦»ã€é«˜å¯ç”¨æ€§

### æ ¸å¿ƒèƒ½åŠ›

```
ç”¨æˆ·ä¸Šä¼  PDF æ–‡æ¡£
    â†“
ç³»ç»Ÿè‡ªåŠ¨è§£æ + å‘é‡åŒ–
    â†“
ç”¨æˆ·æé—®ï¼š"åˆåŒçš„è¿çº¦æ¡æ¬¾æ˜¯ä»€ä¹ˆï¼Ÿ"
    â†“
ç³»ç»Ÿæ£€ç´¢ç›¸å…³æ®µè½ + AI ç†è§£ç”Ÿæˆç­”æ¡ˆ
    â†“
è¿”å›å‡†ç¡®ç­”æ¡ˆ + å¼•ç”¨æ¥æº
```

---

## æ ¸å¿ƒæŠ€æœ¯æ ˆ

### åç«¯æŠ€æœ¯

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|-----|------|------|
| **FastAPI** | 0.104+ | é«˜æ€§èƒ½å¼‚æ­¥ Web æ¡†æ¶ |
| **PostgreSQL** | 14+ | å…³ç³»æ•°æ®åº“ï¼ˆå­˜å‚¨å…ƒæ•°æ®ï¼‰ |
| **Qdrant** | 1.7+ | å‘é‡æ•°æ®åº“ï¼ˆè¯­ä¹‰æ£€ç´¢ï¼‰ |
| **SQLAlchemy** | 2.0+ | ORM æ¡†æ¶ |
| **Pydantic** | 2.0+ | æ•°æ®éªŒè¯ + é…ç½®ç®¡ç† |
| **JWT** | - | æ— çŠ¶æ€è®¤è¯ |

### AI/ML æŠ€æœ¯

| æŠ€æœ¯ | æ¨¡å‹ | ç”¨é€” |
|-----|------|------|
| **åµŒå…¥æ¨¡å‹** | BAAI/bge-large-zh-v1.5 | æ–‡æœ¬å‘é‡åŒ–ï¼ˆ1024ç»´ï¼‰ |
| **LLM** | Qwen/OpenAI/Claude | ç”Ÿæˆå¼å›ç­” |
| **åˆ†è¯å™¨** | LangChain | æ™ºèƒ½æ–‡æœ¬åˆ†å— |

### æ–‡æ¡£è§£æ

| æ ¼å¼ | è§£æåº“ | æå–å†…å®¹ |
|-----|--------|---------|
| **PDF** | PyMuPDF | æ–‡æœ¬ + å…ƒæ•°æ® |
| **Word** | python-docx | æ®µè½ + è¡¨æ ¼ |
| **PPT** | python-pptx | å¹»ç¯ç‰‡ + å¤‡æ³¨ |
| **Excel** | openpyxl | å·¥ä½œè¡¨ + å•å…ƒæ ¼ |

### å‰ç«¯æŠ€æœ¯

- **React 18** + TypeScript
- **Vite** æ„å»ºå·¥å…·
- **Tailwind CSS** æ ·å¼æ¡†æ¶
- **Axios** HTTP å®¢æˆ·ç«¯

---

## æ•´ä½“æ¶æ„

### ç³»ç»Ÿåˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å‰ç«¯å±‚ (React)                       â”‚
â”‚  - æ–‡æ¡£ä¸Šä¼ ç•Œé¢                                            â”‚
â”‚  - æœç´¢/é—®ç­”ç•Œé¢                                           â”‚
â”‚  - æƒé™ç®¡ç†ç•Œé¢                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†• HTTP/WebSocket
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API å±‚ (FastAPI)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ è®¤è¯æˆæƒ  â”‚ æ–‡æ¡£ä¸Šä¼   â”‚ æœç´¢æ£€ç´¢  â”‚ é—®ç­”æœåŠ¡          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ä¸šåŠ¡é€»è¾‘å±‚ (Services)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ç§Ÿæˆ·ä¸Šä¸‹æ–‡ç®¡ç†     â”‚ æƒé™æ£€æŸ¥å™¨        â”‚ æ–‡æ¡£è§£æå™¨    â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ æ–‡æœ¬åˆ†å—æœåŠ¡      â”‚ å‘é‡åµŒå…¥æœåŠ¡      â”‚ æ£€ç´¢å¼•æ“      â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ LLM å®¢æˆ·ç«¯        â”‚ é—®ç­”æœåŠ¡          â”‚ å®¡è®¡æ—¥å¿—      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PostgreSQL         â”‚         Qdrant                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚ ç”¨æˆ·è¡¨        â”‚   â”‚   â”‚ æ–‡æ¡£å‘é‡              â”‚     â”‚
â”‚   â”‚ æ–‡æ¡£è¡¨        â”‚   â”‚   â”‚ (1024ç»´ Embeddings)   â”‚     â”‚
â”‚   â”‚ ç§Ÿæˆ·è¡¨        â”‚   â”‚   â”‚                       â”‚     â”‚
â”‚   â”‚ æƒé™è¡¨        â”‚   â”‚   â”‚ ä½™å¼¦ç›¸ä¼¼åº¦æœç´¢         â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®ç»„ä»¶è¯´æ˜

#### 1. API ç½‘å…³å±‚

**èŒè´£**ï¼š
- è·¯ç”±ç®¡ç†ï¼šå°†è¯·æ±‚åˆ†å‘åˆ°ä¸åŒçš„æœåŠ¡
- è®¤è¯é‰´æƒï¼šéªŒè¯ JWT Token
- ç§Ÿæˆ·è¯†åˆ«ï¼šä»è¯·æ±‚ä¸­æå–ç§Ÿæˆ·ä¿¡æ¯
- é™æµç†”æ–­ï¼šä¿æŠ¤åç«¯æœåŠ¡

**å…³é”®ä¸­é—´ä»¶**ï¼š
```python
# ç§Ÿæˆ·ä¸­é—´ä»¶ï¼ˆè‡ªåŠ¨è¯†åˆ«ç§Ÿæˆ·ï¼‰
TenantMiddleware
  â†“
  æå–ç§Ÿæˆ· ID (Header/å­åŸŸå/è·¯å¾„)
  â†“
  è®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡ (ContextVar)
  â†“
  éªŒè¯ç§Ÿæˆ·çŠ¶æ€ï¼ˆæ˜¯å¦æ´»è·ƒï¼‰
```

#### 2. ä¸šåŠ¡é€»è¾‘å±‚

**æ¨¡å—åŒ–è®¾è®¡**ï¼š

```
services/
â”œâ”€â”€ parser/              # æ–‡æ¡£è§£æï¼ˆå·¥å‚æ¨¡å¼ï¼‰
â”‚   â”œâ”€â”€ PDFParser
â”‚   â”œâ”€â”€ DOCXParser
â”‚   â””â”€â”€ PPTXParser
â”œâ”€â”€ embedder/            # å‘é‡åŒ–ï¼ˆç­–ç•¥æ¨¡å¼ï¼‰
â”‚   â”œâ”€â”€ BGEEmbedder
â”‚   â””â”€â”€ OpenAIEmbedder
â”œâ”€â”€ chunker.py           # æ–‡æœ¬åˆ†å—
â”œâ”€â”€ retriever.py         # å‘é‡æ£€ç´¢
â”œâ”€â”€ qa_service.py        # RAG é—®ç­”
â”œâ”€â”€ permission_checker.py # æƒé™æ£€æŸ¥
â”œâ”€â”€ tenant_context.py    # ç§Ÿæˆ·ä¸Šä¸‹æ–‡
â””â”€â”€ llm.py              # LLM å®¢æˆ·ç«¯
```

#### 3. æ•°æ®å­˜å‚¨å±‚

**åŒåº“è®¾è®¡**ï¼š

| æ•°æ®åº“ | å­˜å‚¨å†…å®¹ | ç”¨é€” |
|-------|---------|------|
| **PostgreSQL** | ç»“æ„åŒ–æ•°æ®ï¼ˆç”¨æˆ·ã€æ–‡æ¡£ã€æƒé™ï¼‰ | äº‹åŠ¡ã€å…³ç³»æŸ¥è¯¢ã€å®¡è®¡æ—¥å¿— |
| **Qdrant** | å‘é‡æ•°æ®ï¼ˆæ–‡æœ¬ embeddingsï¼‰ | é«˜æ•ˆè¯­ä¹‰ç›¸ä¼¼åº¦æœç´¢ |

**ä¸ºä»€ä¹ˆéœ€è¦å‘é‡æ•°æ®åº“ï¼Ÿ**

ä¼ ç»Ÿæ•°æ®åº“ï¼š
```sql
-- åªèƒ½ç²¾ç¡®åŒ¹é…
SELECT * FROM documents WHERE content LIKE '%è¿çº¦æ¡æ¬¾%';
```

å‘é‡æ•°æ®åº“ï¼š
```python
# ç†è§£è¯­ä¹‰ï¼Œæ‰¾åˆ°ç›¸ä¼¼å†…å®¹
query_vector = embed("åˆåŒçš„è¿çº¦è´£ä»»")
# å³ä½¿æ–‡æ¡£ä¸­å†™çš„æ˜¯"ç”²æ–¹è´£ä»»"ã€"è¿çº¦å¤„ç†"ï¼Œä¹Ÿèƒ½åŒ¹é…
results = qdrant.search(query_vector, top_k=5)
```

---

## æ–‡æ¡£å¤„ç†æµç¨‹

### å®Œæ•´å¤„ç†é“¾è·¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: æ–‡æ¡£ä¸Šä¼                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - å‰ç«¯ï¼šæ‹–æ‹½ä¸Šä¼  / é€‰æ‹©æ–‡ä»¶                                â”‚
â”‚ - éªŒè¯ï¼šæ–‡ä»¶ç±»å‹ã€å¤§å°ï¼ˆ50MB é™åˆ¶ï¼‰                        â”‚
â”‚ - ç”Ÿæˆï¼šSHA256 å“ˆå¸Œï¼ˆå»é‡ï¼‰                                â”‚
â”‚ - å­˜å‚¨ï¼šä¿å­˜åˆ°æœ¬åœ° /app/storage/{uuid}.{ext}              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: æ–‡æ¡£è§£æ                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ParserFactory.create(file_type)                         â”‚
â”‚    â†“                                                     â”‚
â”‚ if PDF:                                                  â”‚
â”‚    - PyMuPDF é€é¡µæå–æ–‡æœ¬                                 â”‚
â”‚    - æå–å…ƒæ•°æ®ï¼ˆæ ‡é¢˜ã€ä½œè€…ã€åˆ›å»ºæ—¶é—´ï¼‰                     â”‚
â”‚    - ç»Ÿè®¡é¡µæ•°ã€å­—æ•°                                        â”‚
â”‚ elif DOCX:                                               â”‚
â”‚    - python-docx æå–æ®µè½å’Œè¡¨æ ¼                           â”‚
â”‚    - ä¿ç•™æ ·å¼ä¿¡æ¯                                          â”‚
â”‚ elif PPTX:                                               â”‚
â”‚    - python-pptx æå–å¹»ç¯ç‰‡                               â”‚
â”‚    - åŒ…å«å¤‡æ³¨å’Œæ ‡é¢˜                                        â”‚
â”‚                                                          â”‚
â”‚ Output: {text, metadata, page_count, word_count}        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: æ–‡æœ¬åˆ†å— (Chunking)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ RecursiveCharacterTextSplitter                          â”‚
â”‚    â†“                                                     â”‚
â”‚ é…ç½®ï¼š                                                    â”‚
â”‚ - chunk_size: 1000 å­—ç¬¦                                  â”‚
â”‚ - chunk_overlap: 200 å­—ç¬¦ï¼ˆé¿å…è¯­ä¹‰æ–­è£‚ï¼‰                 â”‚
â”‚ - separators: ["\n\n", "\n", "ã€‚", ".", " "]            â”‚
â”‚    â†“                                                     â”‚
â”‚ è¾“å‡ºï¼š                                                    â”‚
â”‚ [                                                        â”‚
â”‚   "ç¬¬ä¸€ç« ï¼šåˆåŒæ€»åˆ™\næœ¬åˆåŒç”±ç”²ä¹™åŒæ–¹...",                  â”‚
â”‚   "ç¬¬äºŒç« ï¼šæƒåˆ©ä¹‰åŠ¡\nç”²æ–¹åº”å½“å±¥è¡Œ...",                      â”‚
â”‚   ...                                                    â”‚
â”‚ ]                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: å‘é‡åµŒå…¥ (Embedding)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ BGEEmbedder (BAAI/bge-large-zh-v1.5)                    â”‚
â”‚    â†“                                                     â”‚
â”‚ æ‰¹å¤„ç†ï¼ˆ32æ¡/æ‰¹ï¼‰ï¼š                                        â”‚
â”‚ for batch in chunks:                                     â”‚
â”‚     vectors = model.encode(batch)                        â”‚
â”‚     # æ¯ä¸ª chunk â†’ 1024ç»´å‘é‡                            â”‚
â”‚    â†“                                                     â”‚
â”‚ [                                                        â”‚
â”‚   [0.23, -0.45, 0.67, ...], # 1024ç»´                    â”‚
â”‚   [0.12, 0.34, -0.56, ...], # 1024ç»´                    â”‚
â”‚   ...                                                    â”‚
â”‚ ]                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 5: å­˜å‚¨                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PostgreSQLï¼ˆå…ƒæ•°æ®ï¼‰ï¼š                                    â”‚
â”‚ - documents è¡¨ï¼šæ–‡æ¡£ä¿¡æ¯ã€çŠ¶æ€                             â”‚
â”‚ - chunks è¡¨ï¼šæ–‡æœ¬å—ã€é¡µç ã€ä½ç½®                            â”‚
â”‚                                                          â”‚
â”‚ Qdrantï¼ˆå‘é‡ï¼‰ï¼š                                          â”‚
â”‚ - collection: documents                                  â”‚
â”‚ - vectors: 1024ç»´å‘é‡                                     â”‚
â”‚ - payload: {chunk_id, doc_id, text, metadata}           â”‚
â”‚                                                          â”‚
â”‚ çŠ¶æ€æ›´æ–°ï¼šUPLOADING â†’ PARSING â†’ EMBEDDING â†’ READY        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®ä»£ç ç¤ºä¾‹

#### æ–‡æ¡£è§£æï¼ˆPDFï¼‰

```python
class PDFParser:
    def parse(self, file_path: str) -> dict:
        doc = fitz.open(file_path)

        # æå–å…ƒæ•°æ®
        metadata = {
            "title": doc.metadata.get("title", ""),
            "author": doc.metadata.get("author", ""),
            "subject": doc.metadata.get("subject", ""),
            "keywords": doc.metadata.get("keywords", ""),
        }

        # é€é¡µæå–æ–‡æœ¬
        text_parts = []
        for page_num, page in enumerate(doc):
            page_text = page.get_text()
            text_parts.append(page_text)

        full_text = "\n".join(text_parts)

        return {
            "text": full_text,
            "metadata": metadata,
            "page_count": len(doc),
            "word_count": len(full_text.split())
        }
```

#### æ–‡æœ¬åˆ†å—

```python
class ChunkerService:
    def __init__(self):
        self.text_splitter = RecursiveCharacterTextSplitter(
            chunk_size=1000,
            chunk_overlap=200,
            separators=["\n\n", "\n", "ã€‚", "ï¼", "ï¼Ÿ", ".", " ", ""]
        )

    def chunk_text(self, text: str) -> List[str]:
        return self.text_splitter.split_text(text)
```

#### å‘é‡åµŒå…¥

```python
class BGEEmbedder:
    def __init__(self):
        self.model = SentenceTransformer(
            'BAAI/bge-large-zh-v1.5',
            device='cpu'  # æˆ– 'cuda'
        )
        self.dimension = 1024

    def embed_batch(self, texts: List[str]) -> List[np.ndarray]:
        # æ‰¹é‡ç¼–ç ï¼Œæé«˜æ•ˆç‡
        return self.model.encode(
            texts,
            batch_size=32,
            normalize_embeddings=True  # L2å½’ä¸€åŒ–
        )
```

---

## RAG æ£€ç´¢å¢å¼ºç”Ÿæˆ

### ä»€ä¹ˆæ˜¯ RAGï¼Ÿ

**ä¼ ç»Ÿ LLM é—®ç­”**ï¼š
```
ç”¨æˆ·ï¼š"åˆåŒçš„è¿çº¦æ¡æ¬¾æ˜¯ä»€ä¹ˆï¼Ÿ"
    â†“
LLMï¼ˆåªä¾èµ–è®­ç»ƒæ•°æ®ï¼‰ï¼š
"æŠ±æ­‰ï¼Œæˆ‘ä¸çŸ¥é“ä½ å…·ä½“çš„åˆåŒå†…å®¹..."
```

**RAG å¢å¼ºé—®ç­”**ï¼š
```
ç”¨æˆ·ï¼š"åˆåŒçš„è¿çº¦æ¡æ¬¾æ˜¯ä»€ä¹ˆï¼Ÿ"
    â†“
Step 1: å‘é‡æ£€ç´¢ï¼ˆæ‰¾åˆ°ç›¸å…³æ®µè½ï¼‰
    â†“
Step 2: æ„å»ºä¸Šä¸‹æ–‡ï¼ˆå°†ç›¸å…³æ®µè½ä½œä¸ºèƒŒæ™¯ï¼‰
    â†“
Step 3: LLM ç”Ÿæˆï¼ˆåŸºäºçœŸå®æ–‡æ¡£å†…å®¹å›ç­”ï¼‰
    â†“
è¿”å›ï¼š"æ ¹æ®åˆåŒç¬¬5.2æ¡ï¼Œè¿çº¦æ–¹åº”æ‰¿æ‹…..."
```

### å®Œæ•´ RAG æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·æé—®ï¼š                                                â”‚
â”‚ "è¿™ä»½åˆåŒçš„è¿çº¦è´£ä»»æœ‰å“ªäº›ï¼Ÿ"                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: é—®é¢˜å‘é‡åŒ–                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ query = "è¿™ä»½åˆåŒçš„è¿çº¦è´£ä»»æœ‰å“ªäº›ï¼Ÿ"                       â”‚
â”‚ query_vector = bge_embedder.embed(query)                â”‚
â”‚ # â†’ [0.12, -0.34, 0.56, ...] (1024ç»´)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: å‘é‡æ£€ç´¢ï¼ˆQdrantï¼‰                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ results = qdrant.search(                                â”‚
â”‚     collection="documents",                             â”‚
â”‚     query_vector=query_vector,                          â”‚
â”‚     limit=5,  # è¿”å›æœ€ç›¸ä¼¼çš„5ä¸ªå—                         â”‚
â”‚     score_threshold=0.3  # ç›¸ä¼¼åº¦é˜ˆå€¼                    â”‚
â”‚ )                                                       â”‚
â”‚    â†“                                                     â”‚
â”‚ è¿”å›ï¼š                                                    â”‚
â”‚ [                                                        â”‚
â”‚   {                                                      â”‚
â”‚     "text": "ç¬¬5æ¡ è¿çº¦è´£ä»»\n5.1 ç”²æ–¹è¿çº¦...",            â”‚
â”‚     "score": 0.85,                                       â”‚
â”‚     "metadata": {"page": 8, "doc_id": "xxx"}             â”‚
â”‚   },                                                     â”‚
â”‚   {                                                      â”‚
â”‚     "text": "5.2 ä¹™æ–¹è¿çº¦åº”èµ”å¿...",                      â”‚
â”‚     "score": 0.78,                                       â”‚
â”‚     "metadata": {"page": 9, "doc_id": "xxx"}             â”‚
â”‚   },                                                     â”‚
â”‚   ...                                                    â”‚
â”‚ ]                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: æ„å»º Prompt                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ prompt = f"""                                            â”‚
â”‚ ä½ æ˜¯ä¸€ä¸ªæ–‡æ¡£åŠ©æ‰‹ã€‚è¯·åŸºäºä»¥ä¸‹æ–‡æ¡£å†…å®¹å›ç­”ç”¨æˆ·é—®é¢˜ã€‚           â”‚
â”‚                                                          â”‚
â”‚ æ–‡æ¡£å†…å®¹ï¼š                                                â”‚
â”‚ 1. {result[0].text}                                      â”‚
â”‚ 2. {result[1].text}                                      â”‚
â”‚ 3. {result[2].text}                                      â”‚
â”‚ ...                                                      â”‚
â”‚                                                          â”‚
â”‚ ç”¨æˆ·é—®é¢˜ï¼š{query}                                         â”‚
â”‚                                                          â”‚
â”‚ è¯·æä¾›å‡†ç¡®ã€ç®€æ´çš„å›ç­”ï¼Œå¹¶å¼•ç”¨å…·ä½“æ¡æ¬¾ã€‚                    â”‚
â”‚ """                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: LLM ç”Ÿæˆç­”æ¡ˆ                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ response = llm_client.chat_completion(                  â”‚
â”‚     model="qwen-plus",                                   â”‚
â”‚     messages=[{"role": "user", "content": prompt}],      â”‚
â”‚     temperature=0.7,                                     â”‚
â”‚     max_tokens=2000                                      â”‚
â”‚ )                                                        â”‚
â”‚    â†“                                                     â”‚
â”‚ ç”Ÿæˆç­”æ¡ˆï¼š                                                â”‚
â”‚ "æ ¹æ®åˆåŒç¬¬5æ¡è¿çº¦è´£ä»»çš„è§„å®šï¼Œä¸»è¦åŒ…æ‹¬ï¼š                    â”‚
â”‚  1. ç”²æ–¹è¿çº¦ï¼ˆç¬¬5.1æ¡ï¼‰ï¼šåº”æ‰¿æ‹…è¿çº¦é‡‘å¹¶èµ”å¿æŸå¤±             â”‚
â”‚  2. ä¹™æ–¹è¿çº¦ï¼ˆç¬¬5.2æ¡ï¼‰ï¼šéœ€æ”¯ä»˜åˆåŒæ€»é¢çš„20%ä½œä¸ºè¿çº¦é‡‘      â”‚
â”‚  å…·ä½“æ¡æ¬¾è¯·å‚è§åˆåŒç¬¬8-9é¡µã€‚"                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 5: è¿”å›ç»“æœ                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ {                                                        â”‚
â”‚   "question": "è¿™ä»½åˆåŒçš„è¿çº¦è´£ä»»æœ‰å“ªäº›ï¼Ÿ",                â”‚
â”‚   "answer": "æ ¹æ®åˆåŒç¬¬5æ¡...",                           â”‚
â”‚   "sources": [                                           â”‚
â”‚     {"text": "...", "page": 8, "score": 0.85},          â”‚
â”‚     {"text": "...", "page": 9, "score": 0.78}           â”‚
â”‚   ],                                                     â”‚
â”‚   "retrieval_time": 0.12,  # æ£€ç´¢è€—æ—¶ï¼ˆç§’ï¼‰               â”‚
â”‚   "llm_time": 1.34,        # LLMè€—æ—¶ï¼ˆç§’ï¼‰                â”‚
â”‚   "total_time": 1.46       # æ€»è€—æ—¶ï¼ˆç§’ï¼‰                 â”‚
â”‚ }                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®ä»£ç å®ç°

```python
class QAService:
    async def answer_question(
        self,
        question: str,
        tenant_id: str
    ) -> dict:
        # 1. å‘é‡æ£€ç´¢
        start_time = time.time()
        results = await self.retriever.search(
            query=question,
            tenant_id=tenant_id,
            top_k=5
        )
        retrieval_time = time.time() - start_time

        # 2. æ„å»ºä¸Šä¸‹æ–‡
        context = "\n\n".join([
            f"{i+1}. {r['text']}"
            for i, r in enumerate(results)
        ])

        # 3. æ„å»º Prompt
        prompt = f"""
        ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ–‡æ¡£åŠ©æ‰‹ã€‚è¯·åŸºäºä»¥ä¸‹æ–‡æ¡£ç‰‡æ®µå›ç­”ç”¨æˆ·é—®é¢˜ã€‚

        æ–‡æ¡£å†…å®¹ï¼š
        {context}

        ç”¨æˆ·é—®é¢˜ï¼š{question}

        è¦æ±‚ï¼š
        1. åŸºäºæ–‡æ¡£å†…å®¹å›ç­”ï¼Œä¸è¦ç¼–é€ ä¿¡æ¯
        2. å¼•ç”¨å…·ä½“æ®µè½æˆ–æ¡æ¬¾
        3. å¦‚æœæ–‡æ¡£ä¸­æ²¡æœ‰ç›¸å…³ä¿¡æ¯ï¼Œè¯·æ˜ç¡®è¯´æ˜
        """

        # 4. LLM ç”Ÿæˆ
        llm_start = time.time()
        answer = await self.llm_client.chat(prompt)
        llm_time = time.time() - llm_start

        # 5. è¿”å›ç»“æœ
        return {
            "question": question,
            "answer": answer,
            "sources": results,
            "retrieval_time": retrieval_time,
            "llm_time": llm_time,
            "total_time": retrieval_time + llm_time
        }
```

### RAG çš„ä¼˜åŠ¿

| å¯¹æ¯”é¡¹ | ä¼ ç»Ÿ LLM | RAG |
|-------|---------|-----|
| **æ•°æ®æ—¶æ•ˆæ€§** | åªçŸ¥é“è®­ç»ƒæ•°æ® | å®æ—¶æ£€ç´¢æœ€æ–°æ–‡æ¡£ |
| **å‡†ç¡®æ€§** | å¯èƒ½äº§ç”Ÿå¹»è§‰ | åŸºäºçœŸå®æ–‡æ¡£ï¼Œå¯éªŒè¯ |
| **å¯è¿½æº¯æ€§** | æ— æ³•è¯æ˜æ¥æº | æä¾›å¼•ç”¨æ®µè½å’Œé¡µç  |
| **éšç§æ€§** | è®­ç»ƒæ•°æ®å¯èƒ½æ³„éœ² | ä¼ä¸šæ•°æ®ä¸ç¦»å¼€æœ¬åœ° |
| **æˆæœ¬** | éœ€è¦å¾®è°ƒ/è®­ç»ƒ | é›¶æ ·æœ¬å³å¯ä½¿ç”¨ |

---

## å¤šç§Ÿæˆ·æ¶æ„

### ä¸ºä»€ä¹ˆéœ€è¦å¤šç§Ÿæˆ·ï¼Ÿ

**åœºæ™¯ç¤ºä¾‹**ï¼š

- **ä¼ä¸š A**ï¼šæ³•å¾‹æ–‡æ¡£ç®¡ç†ï¼ˆ100ä¸ªç”¨æˆ·ï¼‰
- **ä¼ä¸š B**ï¼šæŠ€æœ¯æ–‡æ¡£ç®¡ç†ï¼ˆ500ä¸ªç”¨æˆ·ï¼‰
- **ä¼ä¸š C**ï¼šè´¢åŠ¡æ–‡æ¡£ç®¡ç†ï¼ˆ50ä¸ªç”¨æˆ·ï¼‰

**å¤šç§Ÿæˆ·æ–¹æ¡ˆ**ï¼š
- ä¸€å¥—ç³»ç»ŸæœåŠ¡æ‰€æœ‰ä¼ä¸š
- æ•°æ®å®Œå…¨éš”ç¦»
- æˆæœ¬å…±äº«ï¼ˆæœåŠ¡å™¨ã€ç»´æŠ¤ï¼‰

### ä¸‰ç§éƒ¨ç½²æ¨¡å¼

#### 1. CLOUD æ¨¡å¼ï¼ˆå…±äº«æ•°æ®åº“ï¼ŒSchema éš”ç¦»ï¼‰

```
PostgreSQL
â”œâ”€â”€ Schema: tenant_a
â”‚   â”œâ”€â”€ users (ä¼ä¸šAç”¨æˆ·)
â”‚   â”œâ”€â”€ documents (ä¼ä¸šAæ–‡æ¡£)
â”‚   â””â”€â”€ chunks
â”œâ”€â”€ Schema: tenant_b
â”‚   â”œâ”€â”€ users (ä¼ä¸šBç”¨æˆ·)
â”‚   â”œâ”€â”€ documents (ä¼ä¸šBæ–‡æ¡£)
â”‚   â””â”€â”€ chunks
â””â”€â”€ Schema: tenant_c
    â””â”€â”€ ...

Qdrant
â”œâ”€â”€ Namespace: tenant_a (ä¼ä¸šAå‘é‡)
â”œâ”€â”€ Namespace: tenant_b (ä¼ä¸šBå‘é‡)
â””â”€â”€ Namespace: tenant_c (ä¼ä¸šCå‘é‡)
```

**ä¼˜åŠ¿**ï¼š
- âœ… æˆæœ¬æœ€ä½ï¼ˆå…±äº«èµ„æºï¼‰
- âœ… ç»´æŠ¤ç®€å•ï¼ˆä¸€ä¸ªæ•°æ®åº“ï¼‰
- âœ… éš”ç¦»å®Œæ•´ï¼ˆSQL + åº”ç”¨å±‚ï¼‰

**é€‚ç”¨**ï¼šSaaS æœåŠ¡ã€ä¸­å°ä¼ä¸š

#### 2. HYBRID æ¨¡å¼ï¼ˆç‹¬ç«‹æ•°æ®åº“ï¼Œå…±äº«å‘é‡åº“ï¼‰

```
PostgreSQL (ä¼ä¸šA)
â””â”€â”€ documents, users, chunks

PostgreSQL (ä¼ä¸šB)
â””â”€â”€ documents, users, chunks

Qdrant (å…±äº«)
â”œâ”€â”€ Namespace: tenant_a
â””â”€â”€ Namespace: tenant_b
```

**ä¼˜åŠ¿**ï¼š
- âœ… å…ƒæ•°æ®å®Œå…¨éš”ç¦»
- âœ… å‘é‡æ£€ç´¢å…±äº«ï¼ˆé™ä½æˆæœ¬ï¼‰
- âœ… çµæ´»å¤‡ä»½

**é€‚ç”¨**ï¼šä¸­å¤§å‹ä¼ä¸šã€åˆè§„è¦æ±‚

#### 3. LOCAL æ¨¡å¼ï¼ˆå®Œå…¨ç‹¬ç«‹ï¼‰

```
ä¼ä¸šAç¯å¢ƒï¼š
â”œâ”€â”€ PostgreSQL (ç‹¬ç«‹å®ä¾‹)
â””â”€â”€ Qdrant (ç‹¬ç«‹å®ä¾‹)

ä¼ä¸šBç¯å¢ƒï¼š
â”œâ”€â”€ PostgreSQL (ç‹¬ç«‹å®ä¾‹)
â””â”€â”€ Qdrant (ç‹¬ç«‹å®ä¾‹)
```

**ä¼˜åŠ¿**ï¼š
- âœ… å®Œå…¨ç¦»çº¿éƒ¨ç½²
- âœ… æ•°æ®ä¸å‡ºå†…ç½‘
- âœ… æœ€é«˜å®‰å…¨æ€§

**é€‚ç”¨**ï¼šæ”¿åºœã€é‡‘èã€å¤§å‹ä¼ä¸š

### ç§Ÿæˆ·è¯†åˆ«æµç¨‹

```
HTTP è¯·æ±‚åˆ°è¾¾
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TenantMiddleware æå–ç§Ÿæˆ·               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä¼˜å…ˆçº§1: è·¯å¾„å‚æ•°                        â”‚
â”‚   /api/tenants/{tenant_id}/documents    â”‚
â”‚                                         â”‚
â”‚ ä¼˜å…ˆçº§2: Query å‚æ•°                      â”‚
â”‚   /api/documents?tenant_id=xxx          â”‚
â”‚                                         â”‚
â”‚ ä¼˜å…ˆçº§3: Header                          â”‚
â”‚   X-Tenant-ID: xxx                      â”‚
â”‚                                         â”‚
â”‚ ä¼˜å…ˆçº§4: å­åŸŸå                          â”‚
â”‚   companyA.docsagent.com                â”‚
â”‚                                         â”‚
â”‚ ä¼˜å…ˆçº§5: é»˜è®¤ç§Ÿæˆ·                        â”‚
â”‚   00000000-0000-0000-0000-000000000001  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
è®¾ç½®ä¸Šä¸‹æ–‡å˜é‡ï¼š
current_tenant = Tenant(id=xxx, name="ä¼ä¸šA")
    â†“
åç»­æ‰€æœ‰æŸ¥è¯¢è‡ªåŠ¨è¿‡æ»¤ï¼š
SELECT * FROM documents WHERE tenant_id = current_tenant.id
```

### æ•°æ®æºè·¯ç”±

```python
class TenantDataSource:
    @staticmethod
    def get_database_session(tenant: Tenant):
        if tenant.deploy_mode == "CLOUD":
            # Schema éš”ç¦»
            session = get_db_session()
            session.execute(f"SET search_path TO {tenant.db_schema}")
            return session

        elif tenant.deploy_mode == "LOCAL":
            # ç‹¬ç«‹æ•°æ®åº“
            engine = create_engine(
                decrypt(tenant.db_connection)
            )
            return Session(engine)

    @staticmethod
    def get_vector_db_client(tenant: Tenant):
        client = QdrantClient(...)
        # ä½¿ç”¨å‘½åç©ºé—´éš”ç¦»
        return client, tenant.vector_namespace
```

### ç§Ÿæˆ·èµ„æºé…é¢

```python
class Tenant:
    storage_quota_bytes: int = 10 * 1024**3  # 10GB
    user_quota: int = 100                     # 100ä¸ªç”¨æˆ·
    document_quota: int = 10000               # 1ä¸‡ä¸ªæ–‡æ¡£

    # å®æ—¶ç»Ÿè®¡
    storage_used_bytes: int = 0
    user_count: int = 0
    document_count: int = 0

    def check_quota(self, resource_type):
        if resource_type == "storage":
            if self.storage_used >= self.storage_quota:
                raise QuotaExceededError("å­˜å‚¨ç©ºé—´å·²æ»¡")
        # ...
```

---

## æƒé™ç³»ç»Ÿ

### ä¸‰å±‚æƒé™ä½“ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬1å±‚ï¼šå¹³å°çº§æƒé™ (PlatformAdmin)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - SUPER_ADMIN: ç®¡ç†æ‰€æœ‰ç§Ÿæˆ·                               â”‚
â”‚ - OPS: ç³»ç»Ÿç»´æŠ¤                                           â”‚
â”‚ - SUPPORT: å®¢æœæŸ¥çœ‹æƒé™                                   â”‚
â”‚ - AUDITOR: å®¡è®¡æ—¥å¿—æŸ¥çœ‹                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬2å±‚ï¼šç§Ÿæˆ·çº§æƒé™ (TenantRole)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - tenant_admin: ç§Ÿæˆ·ç®¡ç†å‘˜ï¼ˆæƒé™ä½255ï¼‰                    â”‚
â”‚ - member: æ™®é€šæˆå‘˜ï¼ˆæƒé™ä½67ï¼‰                             â”‚
â”‚ - guest: è®¿å®¢ï¼ˆæƒé™ä½33ï¼‰                                 â”‚
â”‚ - è‡ªå®šä¹‰è§’è‰²: reviewer, editor, etc.                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬3å±‚ï¼šèµ„æºçº§æƒé™ (ResourcePermission)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - æ–‡æ¡£çº§: å¼ ä¸‰å¯ä»¥ç¼–è¾‘ã€ŠåˆåŒ.pdfã€‹                         â”‚
â”‚ - æ–‡ä»¶å¤¹çº§: æå››å¯ä»¥æŸ¥çœ‹"è´¢åŠ¡æ–‡ä»¶å¤¹"                       â”‚
â”‚ - æƒé™ç»§æ‰¿: å­æ–‡ä»¶å¤¹ç»§æ‰¿çˆ¶æ–‡ä»¶å¤¹æƒé™                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä½è¿ç®—æƒé™è®¾è®¡

**ä¸ºä»€ä¹ˆç”¨ä½è¿ç®—ï¼Ÿ**

ä¼ ç»Ÿæ–¹æ¡ˆï¼š
```python
user.permissions = ["read", "write", "delete"]  # å­—ç¬¦ä¸²æ•°ç»„
```

ä½è¿ç®—æ–¹æ¡ˆï¼š
```python
user.permissions = 7  # äºŒè¿›åˆ¶: 0000 0111
```

**æƒé™å®šä¹‰**ï¼š

| æƒé™ | ä½å€¼ | äºŒè¿›åˆ¶ | è¯´æ˜ |
|-----|------|--------|------|
| READ | 1 | 0000 0001 | è¯»å– |
| WRITE | 2 | 0000 0010 | ç¼–è¾‘ |
| DELETE | 4 | 0000 0100 | åˆ é™¤ |
| SHARE | 8 | 0000 1000 | åˆ†äº« |
| ADMIN | 16 | 0001 0000 | ç®¡ç† |
| DOWNLOAD | 32 | 0010 0000 | ä¸‹è½½ |
| COMMENT | 64 | 0100 0000 | è¯„è®º |
| EXPORT | 128 | 1000 0000 | å¯¼å‡º |

**ç»„åˆæƒé™**ï¼š

```python
# åªè¯»ç”¨æˆ·
READER = READ | DOWNLOAD = 1 | 32 = 33
# äºŒè¿›åˆ¶: 0010 0001

# ç¼–è¾‘ç”¨æˆ·
EDITOR = READ | WRITE | DOWNLOAD | COMMENT = 1 | 2 | 32 | 64 = 99
# äºŒè¿›åˆ¶: 0110 0011

# ç®¡ç†å‘˜
ADMIN = 255  # æ‰€æœ‰ä½éƒ½æ˜¯1
# äºŒè¿›åˆ¶: 1111 1111
```

**æƒé™æ£€æŸ¥**ï¼š

```python
def has_permission(user_perm: int, required_perm: int) -> bool:
    # æŒ‰ä½ä¸è¿ç®—
    return (user_perm & required_perm) == required_perm

# ç¤ºä¾‹
user_perm = 99  # EDITOR (0110 0011)
required = 2    # WRITE  (0000 0010)

99 & 2 = 2  # Trueï¼Œæœ‰å†™æƒé™

required = 4    # DELETE (0000 0100)
99 & 4 = 0  # Falseï¼Œæ— åˆ é™¤æƒé™
```

**ä¼˜åŠ¿**ï¼š
- âœ… æ€§èƒ½é«˜ï¼ˆä½è¿ç®—æå¿«ï¼‰
- âœ… å­˜å‚¨å°ï¼ˆä¸€ä¸ªæ•´æ•°ï¼‰
- âœ… çµæ´»ï¼ˆä»»æ„ç»„åˆï¼‰

### æƒé™æ£€æŸ¥æµç¨‹

```python
async def check_permission(
    user_id: str,
    resource_type: str,
    resource_id: str,
    required_permission: int
) -> bool:
    # 1. å¹³å°ç®¡ç†å‘˜ï¼Ÿ
    if is_platform_admin(user_id):
        return True  # æ‹¥æœ‰æ‰€æœ‰æƒé™

    # 2. ç§Ÿæˆ·å½’å±æ£€æŸ¥
    tenant = get_current_tenant()
    if not user_in_tenant(user_id, tenant.id):
        raise AccessDenied("ä¸å±äºè¯¥ç§Ÿæˆ·")

    # 3. ç§Ÿæˆ·ç®¡ç†å‘˜ï¼Ÿ
    if is_tenant_admin(user_id, tenant.id):
        return True

    # 4. èµ„æºæƒé™æ£€æŸ¥ï¼ˆæ”¯æŒç»§æ‰¿ï¼‰
    permissions = query_resource_permissions(
        user_id, resource_type, resource_id
    )

    # 4.1 ç›´æ¥æˆæƒ
    if permissions.user_perm & required_permission:
        return True

    # 4.2 è§’è‰²æˆæƒ
    if permissions.role_perm & required_permission:
        return True

    # 4.3 éƒ¨é—¨æˆæƒ
    if permissions.dept_perm & required_permission:
        return True

    # 4.4 çˆ¶èµ„æºç»§æ‰¿ï¼ˆé€’å½’ï¼Œæœ€å¤š10å±‚ï¼‰
    parent = get_parent_resource(resource_id)
    if parent and permissions.inherit_parent:
        return check_permission(
            user_id, resource_type, parent.id, required_permission
        )

    # 5. é»˜è®¤æ‹’ç»
    return False
```

### æƒé™ç»§æ‰¿ç¤ºä¾‹

```
Workspace (å·¥ä½œç©ºé—´)
    permissions: user_A = OWNER (255)
    â†“
Folder: è´¢åŠ¡æ–‡ä»¶å¤¹
    permissions: inherit from parent
    â†“
    Subfolder: 2024å¹´æŠ¥è¡¨
        permissions: inherit from parent
        â†“
        Document: Q1è´¢æŠ¥.pdf
            permissions: user_B = READ (1)

æƒé™ç»“æœï¼š
- user_A å¯¹ Q1è´¢æŠ¥.pdf æœ‰ OWNER æƒé™ï¼ˆç»§æ‰¿ï¼‰
- user_B å¯¹ Q1è´¢æŠ¥.pdf åªæœ‰ READ æƒé™ï¼ˆç›´æ¥æˆæƒï¼‰
```

---

## æ€§èƒ½ä¼˜åŒ–

### 1. æ•°æ®åº“ä¼˜åŒ–

#### ç´¢å¼•ç­–ç•¥

```sql
-- æ–‡æ¡£è¡¨ç´¢å¼•
CREATE INDEX idx_documents_tenant_owner
ON documents(tenant_id, owner_id);

CREATE INDEX idx_documents_status
ON documents(status) WHERE status != 'DELETED';

CREATE INDEX idx_documents_hash
ON documents(sha256_hash);

-- æ–‡æœ¬å—ç´¢å¼•
CREATE INDEX idx_chunks_document
ON chunks(document_id, chunk_index);

-- æƒé™è¡¨ç´¢å¼•
CREATE INDEX idx_permissions_resource
ON resource_permissions(resource_type, resource_id, tenant_id);
```

#### è¿æ¥æ± é…ç½®

```python
engine = create_engine(
    database_url,
    poolclass=QueuePool,
    pool_size=20,          # å¸¸é©»è¿æ¥
    max_overflow=10,       # æœ€å¤§æº¢å‡º
    pool_timeout=30,       # è¶…æ—¶æ—¶é—´
    pool_recycle=3600,     # è¿æ¥å›æ”¶ï¼ˆ1å°æ—¶ï¼‰
    pool_pre_ping=True     # è¿æ¥å‰éªŒè¯
)
```

### 2. å‘é‡æ£€ç´¢ä¼˜åŒ–

#### Qdrant é…ç½®

```python
# åˆ›å»ºé›†åˆæ—¶ä¼˜åŒ–
qdrant.create_collection(
    collection_name="documents",
    vectors_config={
        "size": 1024,
        "distance": "Cosine",  # ä½™å¼¦è·ç¦»ï¼ˆé€‚åˆå½’ä¸€åŒ–å‘é‡ï¼‰
    },
    optimizers_config={
        "indexing_threshold": 20000,  # è¾¾åˆ°2ä¸‡æ¡æ—¶æ„å»ºç´¢å¼•
        "memmap_threshold": 50000,    # 5ä¸‡æ¡å¯ç”¨å†…å­˜æ˜ å°„
    },
    hnsw_config={
        "m": 16,              # æ¯ä¸ªèŠ‚ç‚¹çš„é‚»å±…æ•°
        "ef_construct": 100,  # æ„å»ºæ—¶çš„æœç´¢æ·±åº¦
    }
)

# æœç´¢æ—¶ä¼˜åŒ–
results = qdrant.search(
    collection_name="documents",
    query_vector=vector,
    limit=5,
    search_params={
        "hnsw_ef": 128,  # æœç´¢æ—¶çš„æ·±åº¦ï¼ˆè¶Šå¤§è¶Šå‡†ç¡®ä½†è¶Šæ…¢ï¼‰
    }
)
```

#### æ‰¹é‡å¤„ç†

```python
# ä¸å¥½çš„åšæ³•ï¼ˆé€æ¡å¤„ç†ï¼‰
for chunk in chunks:
    vector = embedder.embed(chunk.text)  # Næ¬¡è°ƒç”¨
    qdrant.upsert(vector)                # Næ¬¡ç½‘ç»œè¯·æ±‚

# ä¼˜åŒ–åšæ³•ï¼ˆæ‰¹å¤„ç†ï¼‰
vectors = embedder.embed_batch([c.text for c in chunks])  # 1æ¬¡è°ƒç”¨
qdrant.upsert_batch(vectors)                              # 1æ¬¡ç½‘ç»œè¯·æ±‚
```

### 3. ç¼“å­˜ç­–ç•¥

#### Redis ç¼“å­˜

```python
# ç¼“å­˜å‘é‡æŸ¥è¯¢ç»“æœ
@cache(ttl=3600)  # ç¼“å­˜1å°æ—¶
async def search_documents(query: str, tenant_id: str):
    query_vector = embedder.embed(query)
    return qdrant.search(query_vector)

# ç¼“å­˜ç§Ÿæˆ·ä¿¡æ¯
@cache(ttl=600)  # ç¼“å­˜10åˆ†é’Ÿ
def get_tenant(tenant_id: str):
    return db.query(Tenant).filter_by(id=tenant_id).first()
```

#### å‘é‡åµŒå…¥ç¼“å­˜

```python
# ç›¸åŒæ–‡æœ¬ä¸é‡å¤è®¡ç®—å‘é‡
class CachedEmbedder:
    def __init__(self):
        self.cache = LRUCache(maxsize=10000)

    def embed(self, text: str) -> np.ndarray:
        text_hash = hashlib.md5(text.encode()).hexdigest()

        if text_hash in self.cache:
            return self.cache[text_hash]

        vector = self.model.encode(text)
        self.cache[text_hash] = vector
        return vector
```

### 4. å¼‚æ­¥å¤„ç†

#### åå°ä»»åŠ¡

```python
from fastapi import BackgroundTasks

@app.post("/api/upload")
async def upload_document(
    file: UploadFile,
    background_tasks: BackgroundTasks
):
    # 1. å¿«é€Ÿä¿å­˜æ–‡ä»¶
    file_path = save_file(file)
    doc = create_document_record(file_path)

    # 2. åå°å¤„ç†ï¼ˆè§£æã€å‘é‡åŒ–ï¼‰
    background_tasks.add_task(
        process_document_async,
        doc.id
    )

    # 3. ç«‹å³è¿”å›
    return {"document_id": doc.id, "status": "processing"}

async def process_document_async(doc_id: str):
    # è§£æ â†’ åˆ†å— â†’ å‘é‡åŒ– â†’ å­˜å‚¨
    # è€—æ—¶æ“ä½œä¸é˜»å¡ç”¨æˆ·
    ...
```

### 5. æ€§èƒ½æŒ‡æ ‡

| æ“ä½œ | å“åº”æ—¶é—´ | ä¼˜åŒ–ç›®æ ‡ |
|-----|---------|---------|
| **æ–‡æ¡£ä¸Šä¼ ** | < 1ç§’ | å¼‚æ­¥å¤„ç† |
| **å‘é‡æ£€ç´¢** | < 200ms | Qdrant HNSW |
| **LLM ç”Ÿæˆ** | 1-3ç§’ | æµå¼è¿”å› |
| **æƒé™æ£€æŸ¥** | < 10ms | ç¼“å­˜ + ç´¢å¼• |
| **æ–‡æ¡£è§£æ** | åå° | å¼‚æ­¥é˜Ÿåˆ— |

---

## æ€»ç»“

DocsAgent çš„æŠ€æœ¯æ¶æ„æ ¸å¿ƒäº®ç‚¹ï¼š

### ğŸ¯ æŠ€æœ¯åˆ›æ–°

1. **RAG æŠ€æœ¯**ï¼šå°†ä¼ä¸šæ–‡æ¡£è½¬åŒ–ä¸ºå¯æŸ¥è¯¢çš„çŸ¥è¯†åº“
2. **å‘é‡æ£€ç´¢**ï¼šè¯­ä¹‰ç†è§£è€Œéå…³é”®è¯åŒ¹é…
3. **å¤šç§Ÿæˆ·è®¾è®¡**ï¼šä¸€å¥—ç³»ç»ŸæœåŠ¡å¤šä¸ªä¼ä¸šï¼Œæˆæœ¬å…±äº«

### ğŸ”’ ä¼ä¸šçº§èƒ½åŠ›

1. **ç»†ç²’åº¦æƒé™**ï¼šæ–‡æ¡£çº§ã€æ–‡ä»¶å¤¹çº§æƒé™æ§åˆ¶
2. **æ•°æ®éš”ç¦»**ï¼šSchema/æ•°æ®åº“/å‘½åç©ºé—´ä¸‰ç§éš”ç¦»æ–¹æ¡ˆ
3. **å®¡è®¡è¿½è¸ª**ï¼šå®Œæ•´çš„æ“ä½œæ—¥å¿—å’Œå®¡è®¡è®°å½•

### âš¡ æ€§èƒ½ä¼˜åŒ–

1. **æ‰¹å¤„ç†**ï¼šå‘é‡åµŒå…¥ã€æ•°æ®åº“å†™å…¥æ‰¹é‡å¤„ç†
2. **å¼‚æ­¥å¤„ç†**ï¼šæ–‡æ¡£è§£æä¸é˜»å¡ç”¨æˆ·
3. **æ™ºèƒ½ç¼“å­˜**ï¼šç§Ÿæˆ·ä¿¡æ¯ã€å‘é‡æŸ¥è¯¢ç»“æœç¼“å­˜

### ğŸš€ å¯æ‰©å±•æ€§

1. **æ¨¡å—åŒ–è®¾è®¡**ï¼šè§£æå™¨ã€åµŒå…¥å™¨ã€LLM éƒ½å¯æ›¿æ¢
2. **æ°´å¹³æ‰©å±•**ï¼šæ— çŠ¶æ€ APIï¼Œæ”¯æŒè´Ÿè½½å‡è¡¡
3. **æ’ä»¶åŒ–**ï¼šæ–°æ–‡æ¡£æ ¼å¼ã€æ–° LLM æ¨¡å‹æ˜“äºé›†æˆ

---

**DocsAgent æ˜¯ä¸€ä¸ªç”Ÿäº§çº§çš„æ™ºèƒ½æ–‡æ¡£ç†è§£ç³»ç»Ÿï¼Œé€‚åˆä¼ä¸šçº§éƒ¨ç½²ï¼** ğŸ‰
